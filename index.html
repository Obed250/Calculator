<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EE Pro Calculator + AI</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="Professional Electrical Engineering Scientific Calculator with Gemini AI">
    <link rel="manifest" href="data:application/manifest+json,{'name':'EE Calc AI','short_name':'EEAI','start_url':'.','display':'standalone','background_color':'#0f172a','theme_color':'#38bdf8'}">

    <style>
        :root {
            --bg-color: #020617;
            --calc-bg: #0f172a;
            --screen-bg: #1e293b;
            --text-main: #f8fafc;
            --text-secondary: #7dd3fc;
            --btn-bg: #334155;
            --btn-hover: #475569;
            --btn-active: #1e293b;
            --accent-color: #0ea5e9;
            --operator-color: #334155;
            --ee-function-color: #1e40af;
            --danger-color: #be123c;
            --ai-accent: #a855f7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Consolas', 'Monaco', monospace;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow-y: auto;
        }

        .calculator {
            background-color: var(--calc-bg);
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 24px;
            width: 450px;
            max-width: 100%;
        }

        .display-container {
            background-color: var(--screen-bg);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: right;
            border-left: 4px solid var(--accent-color);
        }

        #history {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-height: 1.2rem;
            margin-bottom: 4px;
            overflow: hidden;
            letter-spacing: 1px;
        }

        #display {
            color: var(--text-main);
            font-size: 2.2rem;
            font-weight: bold;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
        }

        .section-label {
            color: var(--text-secondary);
            font-size: 0.65rem;
            text-transform: uppercase;
            margin: 15px 0 8px 0;
            display: block;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .grid-ee {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .grid-standard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        button {
            border: none;
            border-radius: 4px;
            padding: 12px 5px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
            background-color: var(--btn-bg);
            color: var(--text-main);
        }

        button.ee-fn { background-color: var(--ee-function-color); color: #bae6fd; }
        button.constant { background-color: #0f172a; border: 1px solid #334155; color: #94a3b8; }
        button.ai-btn { background-color: var(--ai-accent); color: white; border: none; font-size: 0.8rem; flex: 1; }
        
        button:active, button.pressed {
            transform: scale(0.95);
            filter: brightness(1.2);
        }

        .operator { background-color: var(--operator-color); }
        .equals { background-color: var(--accent-color); color: white; grid-column: span 2;}
        .clear { background-color: var(--danger-color); }

        .ai-panel {
            margin-top: 10px;
            background: #1e1b4b;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--ai-accent);
        }

        #ai-input {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--ai-accent);
            color: white;
            padding: 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin-bottom: 8px;
            resize: none;
        }

        #ai-output {
            font-size: 0.75rem;
            color: #d8b4fe;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 1px solid #4338ca;
            padding-top: 8px;
            margin-top: 8px;
            display: none;
        }

        .loader {
            display: none;
            width: 14px;
            height: 14px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .calculator { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>

    <div class="calculator">
        <div class="display-container">
            <div id="history">Ready</div>
            <div id="display">0</div>
        </div>

        <span class="section-label">✨ AI Assistant</span>
        <div class="ai-panel">
            <textarea id="ai-input" placeholder="Ask anything..." rows="2"></textarea>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="ai-btn" onclick="askGemini('solve')">✨ Ask</button>
                <div id="ai-loader" class="loader"></div>
            </div>
            <div id="ai-output"></div>
        </div>

        <span class="section-label">Constants & Functions</span>
        <div class="grid-ee">
            <button class="constant" onclick="appendNumber(Math.PI.toFixed(6))">π</button>
            <button class="constant" onclick="appendNumber('8.854e-12')">ε₀</button>
            <button class="constant" onclick="appendNumber('1.256e-6')">μ₀</button>
            <button class="constant" onclick="appendNumber('1.602e-19')">qₑ</button>
            <button class="ee-fn" onclick="eeFunction('sqrt')">√x</button>
            <button class="ee-fn" onclick="eeFunction('pow')">x²</button>
            <button class="ee-fn" onclick="eeFunction('inv')">1/x</button>
            <button class="ee-fn" onclick="eeFunction('log')">log</button>
        </div>

        <span class="section-label">Calculations</span>
        <div class="grid-standard">
            <button class="clear" data-key="Escape" onclick="clearDisplay()">AC</button>
            <button class="operator" data-key="Backspace" onclick="deleteLast()">DEL</button>
            <button class="operator" onclick="appendNumber('e')">EXP</button>
            <button class="operator" data-key="/" onclick="appendOperator('/')">÷</button>
            
            <button data-key="7" onclick="appendNumber('7')">7</button>
            <button data-key="8" onclick="appendNumber('8')">8</button>
            <button data-key="9" onclick="appendNumber('9')">9</button>
            <button class="operator" data-key="*" onclick="appendOperator('*')">×</button>
            
            <button data-key="4" onclick="appendNumber('4')">4</button>
            <button data-key="5" onclick="appendNumber('5')">5</button>
            <button data-key="6" onclick="appendNumber('6')">6</button>
            <button class="operator" data-key="-" onclick="appendOperator('-')">−</button>
            
            <button data-key="1" onclick="appendNumber('1')">1</button>
            <button data-key="2" onclick="appendNumber('2')">2</button>
            <button data-key="3" onclick="appendNumber('3')">3</button>
            <button class="operator" data-key="+" onclick="appendOperator('+')">+</button>
            
            <button data-key="0" onclick="appendNumber('0')">0</button>
            <button data-key="." onclick="appendNumber('.')">.</button>
            <button class="equals" data-key="=" onclick="calculate()">Enter</button>
        </div>
    </div>

    <script>
        const apiKey = ""; // Runtime key
        const display = document.getElementById('display');
        const historyDisplay = document.getElementById('history');
        const aiOutput = document.getElementById('ai-output');
        const aiInput = document.getElementById('ai-input');
        const aiLoader = document.getElementById('ai-loader');
        
        let currentInput = '0';
        let previousInput = '';
        let operation = null;
        let shouldResetScreen = false;

        async function fetchWithRetry(url, payload, retries = 5) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    if (response.ok) return data;
                    
                    lastError = data.error?.message || response.statusText;
                } catch (err) {
                    lastError = err.message;
                }
                // Exponential backoff
                await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
            }
            throw new Error(lastError || "Unknown connection error");
        }

        async function askGemini(mode) {
            const query = aiInput.value.trim();
            const calcValue = display.innerText;
            
            let userPrompt = "";
            if (mode === 'solve') {
                if (!query) {
                    aiOutput.style.display = 'block';
                    aiOutput.innerText = "Please enter a question first.";
                    return;
                }
                userPrompt = `Electrical Engineering Problem: ${query}. Solve precisely with formulas.`;
            } else {
                userPrompt = `The current value on my calculator is ${calcValue}. Explain what this could represent in electronics (e.g., standard resistor, capacitor, frequency) and suggest related parts.`;
            }

            aiLoader.style.display = 'block';
            aiOutput.style.display = 'block';
            aiOutput.innerText = "Thinking...";

            try {
                // Using the specific model supported by the environment
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: "You are a professional Electrical Engineer. Provide concise, accurate technical help. Use standard units and engineering notation." }] }
                };

                const result = await fetchWithRetry(url, payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    aiOutput.innerText = text;
                } else {
                    aiOutput.innerText = "The AI returned an empty response. Please try rephrasing.";
                }
            } catch (error) {
                aiOutput.innerText = `AI Connection Failed: ${error.message}`;
                console.error("Gemini Error:", error);
            } finally {
                aiLoader.style.display = 'none';
            }
        }

        function updateDisplay() {
            display.innerText = currentInput;
            display.scrollLeft = display.scrollWidth;
        }

        function clearDisplay() {
            currentInput = '0';
            previousInput = '';
            operation = null;
            historyDisplay.innerText = 'EE READY...';
            aiOutput.style.display = 'none';
            updateDisplay();
        }

        function deleteLast() {
            if (currentInput === '0' || shouldResetScreen) return;
            currentInput = currentInput.length > 1 ? currentInput.slice(0, -1) : '0';
            updateDisplay();
        }

        function appendNumber(number) {
            if (currentInput === '0' || shouldResetScreen) {
                currentInput = number;
                shouldResetScreen = false;
            } else {
                if (number === '.' && currentInput.includes('.')) return;
                currentInput += number;
            }
            updateDisplay();
        }

        function appendOperator(operator) {
            if (operation !== null && !shouldResetScreen) calculate();
            previousInput = currentInput;
            operation = operator;
            shouldResetScreen = true;
            historyDisplay.innerText = `${previousInput} ${operator}`;
        }

        function eeFunction(type) {
            let val = parseFloat(currentInput);
            if (isNaN(val)) return;
            let res = 0;
            switch(type) {
                case 'sqrt': res = Math.sqrt(val); break;
                case 'pow': res = Math.pow(val, 2); break;
                case 'inv': res = 1/val; break;
                case 'log': res = Math.log10(val); break;
            }
            currentInput = Math.abs(res) < 0.001 || Math.abs(res) > 100000 ? res.toExponential(5) : parseFloat(res.toFixed(8)).toString();
            shouldResetScreen = true;
            updateDisplay();
        }

        function calculate() {
            if (operation === null || shouldResetScreen) return;
            let result;
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);
            if (isNaN(prev) || isNaN(current)) return;

            switch (operation) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': result = current === 0 ? "DIV ERROR" : prev / current; break;
                default: return;
            }

            historyDisplay.innerText = `${previousInput} ${operation} ${currentInput} =`;
            if (typeof result === 'number') {
                currentInput = Math.abs(result) < 0.001 || Math.abs(result) > 100000 ? result.toExponential(5) : (Math.round(result * 100000000) / 100000000).toString();
            } else {
                currentInput = result;
            }
            operation = null;
            shouldResetScreen = true;
            updateDisplay();
        }

        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'TEXTAREA') return;
            const keyMap = { 'Enter': '=', 'Escape': 'Escape', 'Backspace': 'Backspace' };
            const key = keyMap[e.key] || e.key;
            if (key >= '0' && key <= '9') appendNumber(key);
            if (key === '.') appendNumber('.');
            if (key === '=') calculate();
            if (key === 'Backspace') deleteLast();
            if (key === 'Escape') clearDisplay();
            if (['+', '-', '*', '/'].includes(key)) appendOperator(key);
        });
    </script>
</body>
</html>